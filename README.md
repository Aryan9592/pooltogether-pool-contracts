# PoolTogether Prize Savings Protocol

[![Coverage Status](https://coveralls.io/repos/github/pooltogether/pooltogether-pool-contracts/badge.svg?branch=version-3)](https://coveralls.io/github/pooltogether/pooltogether-pool-contracts?branch=version-3)

[![built-with openzeppelin](https://img.shields.io/badge/built%20with-OpenZeppelin-3677FF)](https://docs.openzeppelin.com/)

The [PoolTogether](https://www.pooltogether.com/) Prize Savings Protocol Ethereum smart contracts.

See the [API documentation](https://docs.pooltogether.com/)

# Usage

If you need an ABI or to depend on the contracts, you can use NPM:

```bash
$ yarn add @pooltogether/pooltogether-contracts@alpha
```

Notice the `alpha` tag: this is important!  Otherwise you'll get the old code.

# Development

First clone this repository and enter the directory.

Install dependencies:

```
$ yarn
```

Copy over .envrc and allow [direnv](https://direnv.net/):

```
$ cp .envrc.example .envrc
$ direnv allow
```

## Deploy Locally

First start the local node:

```bash
$ yarn start
```

Now deploy the contracts:

```bash
$ yarn deploy local
```

Interact with the contracts on the command line using [oz-console](https://github.com/pooltogether/oz-console):

```bash
$ yarn console-local
local> contracts.CompoundPrizePoolBuilder.address
```

To give test eth to an account, use the console:

```bash
$ yarn console-local
local> signer.sendTransaction({ to: 'YOUR_ADDRESS', value: ethers.utils.parseEther('100') })
```


# Gas Usage (library drips)

·--------------------------------------------------------------|---------------------------|-------------|------------------------------·
|                     Solc version: 0.6.4                      ·  Optimizer enabled: true  ·  Runs: 200  ·  Block limit: 200000000 gas  │
·······························································|···························|·············|·······························
|  Methods                                                                                                                              │
··································|····························|·············|·············|·············|···············|···············
|  Contract                       ·  Method                    ·  Min        ·  Max        ·  Avg        ·  # calls      ·  chf (avg)   │
··································|····························|·············|·············|·············|···············|···············
|  BalanceDripExposed             ·  drip                      ·      34043  ·      63452  ·      48466  ·           26  ·           -  │
··································|····························|·············|·············|·············|···············|···············
|  BalanceDripExposed             ·  dripTwice                 ·          -  ·          -  ·      53766  ·            2  ·           -  │
··································|····························|·············|·············|·············|···············|···············
|  BalanceDripExposed             ·  setDripRate               ·      23532  ·      67396  ·      56185  ·           11  ·           -  │
··································|····························|·············|·············|·············|···············|···············
|  BalanceDripManagerExposed      ·  activateDrip              ·     107551  ·     140207  ·     132949  ·            9  ·           -  │
··································|····························|·············|·············|·············|···············|···············
|  BalanceDripManagerExposed      ·  deactivateDrip            ·          -  ·          -  ·      32032  ·            2  ·           -  │
··································|····························|·············|·············|·············|···············|···············
|  BalanceDripManagerExposed      ·  setDripRate               ·          -  ·          -  ·      45700  ·            2  ·           -  │
··································|····························|·············|·············|·············|···············|···············
|  CompoundPrizePoolBuilder       ·  create                    ·    1170860  ·    1886259  ·    1409326  ·            3  ·           -  │
··································|····························|·············|·············|·············|···············|···············
|  CompoundPrizePoolHarness       ·  addControlledToken        ·          -  ·          -  ·      65747  ·            2  ·           -  │
··································|····························|·············|·············|·············|···············|···············
|  CompoundPrizePoolHarness       ·  awardExternalERC20        ·      24044  ·      32569  ·      28307  ·            4  ·           -  │
··································|····························|·············|·············|·············|···············|···············
|  CompoundPrizePoolHarness       ·  awardExternalERC721       ·      24322  ·      32749  ·      28536  ·            4  ·           -  │
··································|····························|·············|·············|·············|···············|···············
|  CompoundPrizePoolHarness       ·  depositTo                 ·      87281  ·     392334  ·     275002  ·           48  ·           -  │
··································|····························|·············|·············|·············|···············|···············
|  CompoundPrizePoolHarness       ·  emergencyShutdown         ·          -  ·          -  ·      14455  ·            8  ·           -  │
··································|····························|·············|·············|·············|···············|···············
|  CompoundPrizePoolHarness       ·  initializeAll             ·     283149  ·     316371  ·     293912  ·           75  ·           -  │
··································|····························|·············|·············|·············|···············|···············
|  CompoundPrizePoolHarness       ·  setCreditRateOf           ·      32752  ·      47812  ·      47442  ·           84  ·           -  │
··································|····························|·············|·············|·············|···············|···············
|  CompoundPrizePoolHarness       ·  setCurrentTime            ·      22272  ·      41484  ·      30338  ·           93  ·           -  │
··································|····························|·············|·············|·············|···············|···············
|  CompoundPrizePoolHarness       ·  setPrizeStrategy          ·          -  ·          -  ·      30565  ·            2  ·           -  │
··································|····························|·············|·············|·············|···············|···············
|  CompoundPrizePoolHarness       ·  setTimelockBalance        ·          -  ·          -  ·      41532  ·            2  ·           -  │
··································|····························|·············|·············|·············|···············|···············
|  CompoundPrizePoolHarness       ·  sweepTimelockBalances     ·      32404  ·      72493  ·      51760  ·           10  ·           -  │
··································|····························|·············|·············|·············|···············|···············
|  CompoundPrizePoolHarness       ·  timelockDepositTo         ·     115561  ·     174377  ·     144969  ·            4  ·           -  │
··································|····························|·············|·············|·············|···············|···············
|  CompoundPrizePoolHarness       ·  withdrawInstantlyFrom     ·     101594  ·     190698  ·     128963  ·           22  ·           -  │
··································|····························|·············|·············|·············|···············|···············
|  CompoundPrizePoolHarness       ·  withdrawWithTimelockFrom  ·     126774  ·     177130  ·     153844  ·           15  ·           -  │
··································|····························|·············|·············|·············|···············|···············
|  CompoundPrizePoolProxyFactory  ·  create                    ·          -  ·          -  ·      64440  ·            2  ·           -  │
··································|····························|·············|·············|·············|···············|···············
|  Comptroller                    ·  transferOwnership         ·          -  ·          -  ·      30964  ·            1  ·           -  │
··································|····························|·············|·············|·············|···············|···············
|  ComptrollerHarness             ·  activateBalanceDrip       ·     120319  ·     148836  ·     127642  ·           12  ·           -  │
··································|····························|·············|·············|·············|···············|···············
|  ComptrollerHarness             ·  activateVolumeDrip        ·     146158  ·     146192  ·     146170  ·           14  ·           -  │
··································|····························|·············|·············|·············|···············|···············
|  ComptrollerHarness             ·  beforeTokenMint           ·          -  ·          -  ·      68009  ·            2  ·           -  │
··································|····························|·············|·············|·············|···············|···············
|  ComptrollerHarness             ·  beforeTokenTransfer       ·          -  ·          -  ·      89503  ·            1  ·           -  │
··································|····························|·············|·············|·············|···············|···············
|  ComptrollerHarness             ·  claimDrip                 ·          -  ·          -  ·      22851  ·            4  ·           -  │
··································|····························|·············|·············|·············|···············|···············
|  ComptrollerHarness             ·  deactivateBalanceDrip     ·          -  ·          -  ·      29611  ·            2  ·           -  │
··································|····························|·············|·············|·············|···············|···············
|  ComptrollerHarness             ·  deactivateVolumeDrip      ·          -  ·          -  ·      23078  ·            2  ·           -  │
··································|····························|·············|·············|·············|···············|···············
|  ComptrollerHarness             ·  initialize                ·          -  ·          -  ·      80173  ·           47  ·           -  │
··································|····························|·············|·············|·············|···············|···············
|  ComptrollerHarness             ·  setBalanceDripRate        ·          -  ·          -  ·      40982  ·            2  ·           -  │
··································|····························|·············|·············|·············|···············|···············
|  ComptrollerHarness             ·  setCurrentTime            ·      22240  ·      41452  ·      29822  ·           93  ·           -  │
··································|····························|·············|·············|·············|···············|···············
|  ComptrollerHarness             ·  setReserveRateMantissa    ·          -  ·          -  ·      43583  ·            2  ·           -  │
··································|····························|·············|·············|·············|···············|···············
|  ComptrollerHarness             ·  setVolumeDrip             ·          -  ·          -  ·      34773  ·            2  ·           -  │
··································|····························|·············|·············|·············|···············|···············
|  ComptrollerHarness             ·  updateAndClaimDrips       ·      58928  ·     147954  ·     119655  ·           22  ·           -  │
··································|····························|·············|·············|·············|···············|···············
|  ComptrollerHarness             ·  updateDrips               ·          -  ·          -  ·      95822  ·            1  ·           -  │
··································|····························|·············|·············|·············|···············|···············
|  ControlledToken                ·  approve                   ·          -  ·          -  ·      45048  ·            1  ·           -  │
··································|····························|·············|·············|·············|···············|···············
|  ControlledToken                ·  initialize                ·     159526  ·     208613  ·     162224  ·           37  ·           -  │
··································|····························|·············|·············|·············|···············|···············
|  ControlledTokenProxyFactory    ·  create                    ·          -  ·          -  ·      64440  ·            2  ·           -  │
··································|····························|·············|·············|·············|···············|···············
|  CounterfactualActionFactory    ·  cancel                    ·          -  ·          -  ·      68355  ·            2  ·           -  │
··································|····························|·············|·············|·············|···············|···············
|  CounterfactualActionFactory    ·  depositTo                 ·          -  ·          -  ·      74726  ·            2  ·           -  │
··································|····························|·············|·············|·············|···············|···············
|  CounterfactualActionFactory    ·  initialize                ·          -  ·          -  ·     310995  ·            4  ·           -  │
··································|····························|·············|·············|·············|···············|···············
|  CTokenMock                     ·  accrueCustom              ·      38177  ·      38321  ·      38262  ·            9  ·           -  │
··································|····························|·············|·············|·············|···············|···············
|  CTokenMock                     ·  mint                      ·      51929  ·      91687  ·      78434  ·            6  ·           -  │
··································|····························|·············|·············|·············|···············|···············
|  DoppelgangerWithExec           ·  __waffle__call            ·      23868  ·     170483  ·      77799  ·           23  ·           -  │
··································|····························|·············|·············|·············|···············|···············
|  DoppelgangerWithExec           ·  __waffle__mockReturns     ·      16713  ·     105629  ·      77734  ·          449  ·           -  │
··································|····························|·············|·············|·············|···············|···············
|  ERC20Mintable                  ·  approve                   ·      24883  ·      44155  ·      43693  ·           50  ·           -  │
··································|····························|·············|·············|·············|···············|···············
|  ERC20Mintable                  ·  mint                      ·      50846  ·      65930  ·      61910  ·           57  ·           -  │
··································|····························|·············|·············|·············|···············|···············
|  ERC721Mintable                 ·  mint                      ·          -  ·          -  ·     170765  ·            1  ·           -  │
··································|····························|·············|·············|·············|···············|···············
|  MappedSinglyLinkedListExposed  ·  addAddress                ·      56158  ·      71170  ·      59168  ·           10  ·           -  │
··································|····························|·············|·············|·············|···············|···············
|  MappedSinglyLinkedListExposed  ·  addAddresses              ·          -  ·          -  ·      71891  ·           24  ·           -  │
··································|····························|·············|·············|·············|···············|···············
|  MappedSinglyLinkedListExposed  ·  clearAll                  ·      25671  ·      28692  ·      27685  ·            3  ·           -  │
··································|····························|·············|·············|·············|···············|···············
|  MappedSinglyLinkedListExposed  ·  initialize                ·          -  ·          -  ·      42994  ·           14  ·           -  │
··································|····························|·············|·············|·············|···············|···············
|  MappedSinglyLinkedListExposed  ·  removeAddress             ·          -  ·          -  ·      26588  ·            2  ·           -  │
··································|····························|·············|·············|·············|···············|···············
|  PrizeStrategyHarness           ·  addExternalErc721Award    ·     124238  ·     129625  ·     127829  ·            3  ·           -  │
··································|····························|·············|·············|·············|···············|···············
|  PrizeStrategyHarness           ·  completeAward             ·      85471  ·     235669  ·     184134  ·           16  ·           -  │
··································|····························|·············|·············|·············|···············|···············
|  PrizeStrategyHarness           ·  initialize                ·     282232  ·     354776  ·     323039  ·           67  ·           -  │
··································|····························|·············|·············|·············|···············|···············
|  PrizeStrategyHarness           ·  setCurrentTime            ·      22227  ·      41475  ·      30978  ·          107  ·           -  │
··································|····························|·············|·············|·············|···············|···············
|  PrizeStrategyHarness           ·  setRngRequest             ·      13754  ·      42532  ·      30185  ·           14  ·           -  │
··································|····························|·············|·············|·············|···············|···············
|  PrizeStrategyHarness           ·  setRngService             ·          -  ·          -  ·      31388  ·            2  ·           -  │
··································|····························|·············|·············|·············|···············|···············
|  PrizeStrategyHarness           ·  startAward                ·      72678  ·      80822  ·      77948  ·           17  ·           -  │
··································|····························|·············|·············|·············|···············|···············
|  PrizeStrategyProxyFactory      ·  create                    ·          -  ·          -  ·      64440  ·            2  ·           -  │
··································|····························|·············|·············|·············|···············|···············
|  RNGServiceMock                 ·  setRandomNumber           ·          -  ·          -  ·      22225  ·           11  ·           -  │
··································|····························|·············|·············|·············|···············|···············
|  RNGServiceMock                 ·  setRequestFee             ·      62780  ·      62792  ·      62791  ·           30  ·           -  │
··································|····························|·············|·············|·············|···············|···············
|  Ticket                         ·  initialize                ·     188362  ·     207802  ·     206031  ·           33  ·           -  │
··································|····························|·············|·············|·············|···············|···············
|  Ticket                         ·  transfer                  ·     151890  ·     233438  ·     179913  ·            8  ·           -  │
··································|····························|·············|·············|·············|···············|···············
|  TicketProxyFactory             ·  create                    ·          -  ·          -  ·      64440  ·            1  ·           -  │
··································|····························|·············|·············|·············|···············|···············
|  UInt256ArrayExposed            ·  remove                    ·          -  ·          -  ·      27425  ·            2  ·           -  │
··································|····························|·············|·············|·············|···············|···············
|  VolumeDripExposed              ·  mint                      ·      43197  ·      75618  ·      57805  ·           11  ·           -  │
··································|····························|·············|·············|·············|···············|···············
|  VolumeDripExposed              ·  poke                      ·      23355  ·      57504  ·      47747  ·            7  ·           -  │
··································|····························|·············|·············|·············|···············|···············
|  VolumeDripExposed              ·  setNewPeriod              ·          -  ·          -  ·      66687  ·            8  ·           -  │
··································|····························|·············|·············|·············|···············|···············
|  VolumeDripExposed              ·  setNextPeriod             ·          -  ·          -  ·      27638  ·            1  ·           -  │
··································|····························|·············|·············|·············|···············|···············
|  VolumeDripManagerExposed       ·  activate                  ·     105321  ·     137977  ·     130719  ·            9  ·           -  │
··································|····························|·············|·············|·············|···············|···············
|  VolumeDripManagerExposed       ·  deactivate                ·          -  ·          -  ·      20950  ·            2  ·           -  │
··································|····························|·············|·············|·············|···············|···············
|  VolumeDripManagerExposed       ·  set                       ·          -  ·          -  ·      29847  ·            2  ·           -  │
··································|····························|·············|·············|·············|···············|···············
|  Deployments                                                 ·                                         ·  % of limit   ·              │
·······························································|·············|·············|·············|···············|···············
|  BalanceDripExposed                                          ·          -  ·          -  ·     514581  ·        0.3 %  ·           -  │
·······························································|·············|·············|·············|···············|···············
|  BalanceDripManagerExposed                                   ·          -  ·          -  ·     802524  ·        0.4 %  ·           -  │
·······························································|·············|·············|·············|···············|···············
|  CompoundPrizePoolBuilder                                    ·    1003866  ·    1003878  ·    1003874  ·        0.5 %  ·           -  │
·······························································|·············|·············|·············|···············|···············
|  CompoundPrizePoolHarness                                    ·          -  ·          -  ·    4144051  ·        2.1 %  ·           -  │
·······························································|·············|·············|·············|···············|···············
|  CompoundPrizePoolProxyFactory                               ·          -  ·          -  ·    4276901  ·        2.1 %  ·           -  │
·······························································|·············|·············|·············|···············|···············
|  Comptroller                                                 ·          -  ·          -  ·    3586239  ·        1.8 %  ·           -  │
·······························································|·············|·············|·············|···············|···············
|  ComptrollerHarness                                          ·          -  ·          -  ·    3594227  ·        1.8 %  ·           -  │
·······························································|·············|·············|·············|···············|···············
|  ControlledToken                                             ·          -  ·          -  ·    1336130  ·        0.7 %  ·           -  │
·······························································|·············|·············|·············|···············|···············
|  ControlledTokenProxyFactory                                 ·          -  ·          -  ·    1569560  ·        0.8 %  ·           -  │
·······························································|·············|·············|·············|···············|···············
|  CounterfactualActionFactory                                 ·          -  ·          -  ·     661816  ·        0.3 %  ·           -  │
·······························································|·············|·············|·············|···············|···············
|  CTokenMock                                                  ·    1291945  ·    1291969  ·    1291957  ·        0.6 %  ·           -  │
·······························································|·············|·············|·············|···············|···············
|  DoppelgangerWithExec                                        ·          -  ·          -  ·     544517  ·        0.3 %  ·           -  │
·······························································|·············|·············|·············|···············|···············
|  ERC20Mintable                                               ·          -  ·          -  ·     888830  ·        0.4 %  ·           -  │
·······························································|·············|·············|·············|···············|···············
|  ERC721Mintable                                              ·          -  ·          -  ·    1834892  ·        0.9 %  ·           -  │
·······························································|·············|·············|·············|···············|···············
|  ExtendedSafeCastExposed                                     ·          -  ·          -  ·     158719  ·        0.1 %  ·           -  │
·······························································|·············|·············|·············|···············|···············
|  MappedSinglyLinkedListExposed                               ·          -  ·          -  ·     457723  ·        0.2 %  ·           -  │
·······························································|·············|·············|·············|···············|···············
|  PrizeStrategyHarness                                        ·          -  ·          -  ·    2589487  ·        1.3 %  ·           -  │
·······························································|·············|·············|·············|···············|···············
|  PrizeStrategyProxyFactory                                   ·          -  ·          -  ·    2791399  ·        1.4 %  ·           -  │
·······························································|·············|·············|·············|···············|···············
|  RelayRecipient                                              ·          -  ·          -  ·     150757  ·        0.1 %  ·           -  │
·······························································|·············|·············|·············|···············|···············
|  RNGServiceMock                                              ·          -  ·          -  ·     177319  ·        0.1 %  ·           -  │
·······························································|·············|·············|·············|···············|···············
|  Ticket                                                      ·          -  ·          -  ·    1854254  ·        0.9 %  ·           -  │
·······························································|·············|·············|·············|···············|···············
|  TicketProxyFactory                                          ·          -  ·          -  ·    2088201  ·          1 %  ·           -  │
·······························································|·············|·············|·············|···············|···············
|  TrustedForwarder                                            ·          -  ·          -  ·    1293110  ·        0.6 %  ·           -  │
·······························································|·············|·············|·············|···············|···············
|  UInt256ArrayExposed                                         ·          -  ·          -  ·     287527  ·        0.1 %  ·           -  │
·······························································|·············|·············|·············|···············|···············
|  VolumeDripExposed                                           ·          -  ·          -  ·     892164  ·        0.4 %  ·           -  │
·······························································|·············|·············|·············|···············|···············
|  VolumeDripManagerExposed                                    ·          -  ·          -  ·     727237  ·        0.4 %  ·           -  │
·--------------------------------------------------------------|-------------|-------------|-------------|---------------|--------------·

